# =============================================================================
# GitHub Scope Helper
# =============================================================================
ensure_gh_scope() {
  local host="$1"
  local scope="admin:public_key"

  echo "üîé Checking GitHub OAuth scopes for $host‚Ä¶"

  # Get scopes for the host
  local scopes
  scopes="$(gh auth status --hostname "$host" --json scopes -q '.scopes[]' 2>/dev/null | tr '\n' ' ' || true)"

  if [[ "$scopes" =~ $scope ]]; then
    echo "‚úî $host already has required scope: '$scope'"
    return 0
  fi

  echo "‚ö†Ô∏è '$scope' scope missing for $host ‚Äî requesting now‚Ä¶"
  gh auth refresh -h "$host" -s "$scope" || {
    echo "‚ùå Failed to obtain '$scope' scope for $host"
    return 1
  }

  echo "‚úî Scope '$scope' granted for $host"
}

# =============================================================================
# Setup SSH keys
# =============================================================================
setup_ssh() {
  # ... existing setup_ssh code ...

  echo "‚Ä¢ Uploading $LABEL key to GitHub..."

  if [[ "$LABEL" == "personal" ]]; then
    ensure_gh_scope "github.com"
    gh ssh-key add "${KEYFILE}.pub" \
      --title "personal-${DEVICE_NAME}-bootstrap-$(date +%Y%m%d-%H%M%S)" \
      || echo "‚ö†Ô∏è Could not upload personal key ‚Äî even after scope refresh."

  else
    # Ensure auth for corporate host
    if ! gh auth status --hostname github.com-corp >/dev/null 2>&1; then
      echo "üîê Authenticating GitHub CLI for corporate identity..."
      gh auth login --hostname github.com-corp
    fi

    ensure_gh_scope "github.com-corp"
    gh ssh-key add "${KEYFILE}.pub" \
      --title "corp-${DEVICE_NAME}-bootstrap-$(date +%Y%m%d-%H%M%S)" \
      --hostname github.com-corp \
      || echo "‚ö†Ô∏è Could not upload corp key ‚Äî even after scope refresh."
  fi

  # ... rest of setup_ssh code ...
}